<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hospital Chat System</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 800px;
        height: 90vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        text-align: center;
      }

      .header h1 {
        margin: 0;
        font-size: 24px;
      }

      .status {
        font-size: 14px;
        margin-top: 5px;
        opacity: 0.9;
      }

      .login-section {
        padding: 40px;
        text-align: center;
      }

      .login-section h2 {
        margin-bottom: 30px;
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .chat-section {
        display: none;
        flex: 1;
        flex-direction: column;
        height: 100%;
      }

      .chat-info {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .room-info {
        font-weight: 600;
        color: #495057;
      }

      .user-count {
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
      }

      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #fafafa;
      }

      .message {
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 70%;
        word-wrap: break-word;
      }

      .message.own {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .message.other {
        background: white;
        border: 1px solid #e9ecef;
        margin-right: auto;
      }

      .message.system {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        text-align: center;
        margin: 10px auto;
        max-width: 50%;
        font-style: italic;
      }

      .message-header {
        font-size: 12px;
        opacity: 0.8;
        margin-bottom: 4px;
      }

      .message-content {
        font-size: 14px;
        line-height: 1.4;
      }

      .message-time {
        font-size: 11px;
        opacity: 0.6;
        margin-top: 4px;
      }

      .typing-indicator {
        padding: 10px 20px;
        font-style: italic;
        color: #6c757d;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
        min-height: 20px;
      }

      .input-section {
        padding: 20px;
        border-top: 1px solid #e9ecef;
        background: white;
        border-radius: 0 0 12px 12px;
      }

      .input-form {
        display: flex;
        gap: 10px;
      }

      .message-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 24px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s;
      }

      .message-input:focus {
        border-color: #667eea;
      }

      .send-btn {
        padding: 12px 20px;
        border-radius: 24px;
        white-space: nowrap;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        border: 1px solid #f5c6cb;
      }

      .connection-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .connected {
        background: #d4edda;
        color: #155724;
      }

      .disconnected {
        background: #f8d7da;
        color: #721c24;
      }

      .connecting {
        background: #fff3cd;
        color: #856404;
      }

      @media (max-width: 600px) {
        .container {
          width: 95%;
          height: 95vh;
        }

        .message {
          max-width: 85%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üè• Hospital Chat System</h1>
        <div class="status">
          Connection:
          <span id="connectionStatus" class="connection-status disconnected"
            >Disconnected</span
          >
        </div>
      </div>

      <!-- Login Section -->
      <div id="loginSection" class="login-section">
        <h2>Join a Chat Room</h2>
        <div class="form-group">
          <label for="userName">Your Name:</label>
          <input
            type="text"
            id="userName"
            placeholder="Enter your name (e.g., Dr. Smith)"
            maxlength="50"
          />
        </div>
        <div class="form-group">
          <label for="roomId">Room/Department:</label>
          <input
            type="text"
            id="roomId"
            placeholder="Enter room ID (e.g., emergency, surgery)"
            maxlength="50"
            value="emergency"
          />
        </div>
        <button id="joinBtn" class="btn">Join Chat Room</button>
        <div id="loginError"></div>
      </div>

      <!-- Chat Section -->
      <div id="chatSection" class="chat-section">
        <div class="chat-info">
          <div class="room-info">Room: <span id="currentRoom">-</span></div>
          <div class="user-count" id="userCount">0 users</div>
        </div>

        <div class="messages-container" id="messagesContainer">
          <!-- Messages will appear here -->
        </div>

        <div class="typing-indicator" id="typingIndicator"></div>

        <div class="input-section">
          <form class="input-form" id="messageForm">
            <input
              type="text"
              id="messageInput"
              class="message-input"
              placeholder="Type your message..."
              maxlength="500"
              autocomplete="off"
            />
            <button type="submit" class="btn send-btn">Send</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // WebSocket connection and state management
      class HospitalChat {
        constructor() {
          this.socket = null;
          this.currentUser = null;
          this.currentRoom = null;
          this.typingTimer = null;
          this.isTyping = false;
          this.typingTimeout = null;

          this.initializeElements();
          this.setupEventListeners();
          this.connectToServer();
        }

        initializeElements() {
          this.elements = {
            connectionStatus: document.getElementById("connectionStatus"),
            loginSection: document.getElementById("loginSection"),
            chatSection: document.getElementById("chatSection"),
            userName: document.getElementById("userName"),
            roomId: document.getElementById("roomId"),
            joinBtn: document.getElementById("joinBtn"),
            loginError: document.getElementById("loginError"),
            currentRoom: document.getElementById("currentRoom"),
            userCount: document.getElementById("userCount"),
            messagesContainer: document.getElementById("messagesContainer"),
            typingIndicator: document.getElementById("typingIndicator"),
            messageForm: document.getElementById("messageForm"),
            messageInput: document.getElementById("messageInput"),
          };
        }

        setupEventListeners() {
          // Join room button
          this.elements.joinBtn.addEventListener("click", () =>
            this.joinRoom()
          );

          // Enter key on login inputs
          this.elements.userName.addEventListener("keypress", (e) => {
            if (e.key === "Enter") this.joinRoom();
          });
          this.elements.roomId.addEventListener("keypress", (e) => {
            if (e.key === "Enter") this.joinRoom();
          });

          // Message form
          this.elements.messageForm.addEventListener("submit", (e) => {
            e.preventDefault();
            this.sendMessage();
          });

          // Typing indicators
          this.elements.messageInput.addEventListener("input", () => {
            this.handleTyping();
          });

          this.elements.messageInput.addEventListener("blur", () => {
            this.stopTyping();
          });
        }

        connectToServer() {
          this.updateConnectionStatus("connecting", "Connecting...");

          // Initialize Socket.IO connection
          this.socket = io({
            transports: ["websocket", "polling"],
          });

          // Connection events
          this.socket.on("connect", () => {
            console.log("Connected to server");
            this.updateConnectionStatus("connected", "Connected");
          });

          this.socket.on("disconnect", (reason) => {
            console.log("Disconnected:", reason);
            this.updateConnectionStatus("disconnected", "Disconnected");
            this.showError(`Connection lost: ${reason}`);
          });

          this.socket.on("connect_error", (error) => {
            console.error("Connection error:", error);
            this.updateConnectionStatus("disconnected", "Connection Error");
            this.showError("Failed to connect to server");
          });

          // Chat events - FIXED EVENT HANDLERS
          this.socket.on("joined_room", (data) => {
            console.log("‚úÖ Joined room:", data);
            this.onJoinedRoom(data);
          });

          this.socket.on("user_joined", (data) => {
            console.log("üë§ User joined:", data);
            this.addSystemMessage(`${data.userName} joined the room`);
          });

          this.socket.on("user_left", (data) => {
            console.log("üë§ User left:", data);
            this.addSystemMessage(`${data.userName} left the room`);
          });

          this.socket.on("room_info", (data) => {
            console.log("üìä Room info:", data);
            this.updateRoomInfo(data);
          });

          // CRITICAL FIX: Proper message event handler
          this.socket.on("new_message", (message) => {
            console.log("üí¨ New message received:", message);
            this.addMessage(message);
          });

          // CRITICAL FIX: Proper typing event handler
          this.socket.on("user_typing", (data) => {
            console.log("‚å®Ô∏è Typing indicator:", data);
            this.handleTypingIndicator(data);
          });

          this.socket.on("error", (error) => {
            console.error("Socket error:", error);
            this.showError(error.message || "An error occurred");
          });

          // Debug: Log all incoming events
          this.socket.onAny((eventName, ...args) => {
            console.log(`üîî Received event: ${eventName}`, args);
          });
        }

        updateConnectionStatus(status, text) {
          this.elements.connectionStatus.textContent = text;
          this.elements.connectionStatus.className = `connection-status ${status}`;
        }

        joinRoom() {
          const userName = this.elements.userName.value.trim();
          const roomId = this.elements.roomId.value.trim();

          if (!userName || !roomId) {
            this.showError("Please enter both your name and room ID");
            return;
          }

          if (userName.length < 2 || userName.length > 50) {
            this.showError("Name must be between 2 and 50 characters");
            return;
          }

          if (roomId.length < 2 || roomId.length > 50) {
            this.showError("Room ID must be between 2 and 50 characters");
            return;
          }

          this.currentUser = {
            userId: "user_" + Math.random().toString(36).substr(2, 9),
            userName: userName,
            roomId: roomId,
          };

          this.elements.joinBtn.disabled = true;
          this.elements.joinBtn.textContent = "Joining...";

          console.log("üö™ Attempting to join room:", this.currentUser);

          // Send join room event
          this.socket.emit("join_room", this.currentUser);
        }

        onJoinedRoom(data) {
          console.log("üéâ Successfully joined room:", data);

          this.currentRoom = data.roomId;
          this.elements.currentRoom.textContent = data.roomId;

          // Hide login, show chat
          this.elements.loginSection.style.display = "none";
          this.elements.chatSection.style.display = "flex";

          // Focus on message input
          this.elements.messageInput.focus();

          // Add welcome message
          this.addSystemMessage(
            `Welcome to ${data.roomId}! You can start chatting now.`
          );

          // Clear any errors
          this.clearError();
        }

        sendMessage() {
          const content = this.elements.messageInput.value.trim();

          if (!content) {
            return;
          }

          if (content.length > 500) {
            this.showError("Message too long (max 500 characters)");
            return;
          }

          console.log("üì§ Sending message:", content);

          // Send message
          this.socket.emit("send_message", {
            content: content,
            type: "text",
          });

          // Clear input
          this.elements.messageInput.value = "";
          this.stopTyping();
        }

        addMessage(message) {
          console.log("üìù Adding message to UI:", message);

          const isOwnMessage = message.userId === this.currentUser?.userId;

          const messageEl = document.createElement("div");
          messageEl.className = `message ${isOwnMessage ? "own" : "other"}`;

          const time = new Date(message.timestamp).toLocaleTimeString();

          messageEl.innerHTML = `
                    ${
                      !isOwnMessage
                        ? `<div class="message-header">${this.escapeHtml(
                            message.userName
                          )}</div>`
                        : ""
                    }
                    <div class="message-content">${this.escapeHtml(
                      message.content
                    )}</div>
                    <div class="message-time">${time}</div>
                `;

          this.elements.messagesContainer.appendChild(messageEl);
          this.scrollToBottom();
        }

        addSystemMessage(text) {
          console.log("‚ÑπÔ∏è Adding system message:", text);

          const messageEl = document.createElement("div");
          messageEl.className = "message system";
          messageEl.innerHTML = `<div class="message-content">${this.escapeHtml(
            text
          )}</div>`;

          this.elements.messagesContainer.appendChild(messageEl);
          this.scrollToBottom();
        }

        updateRoomInfo(data) {
          console.log("üìä Updating room info:", data);
          this.elements.userCount.textContent = `${data.userCount} user${
            data.userCount !== 1 ? "s" : ""
          }`;
        }

        handleTyping() {
          if (!this.isTyping) {
            this.isTyping = true;
            this.socket.emit("typing_start");
            console.log("‚å®Ô∏è Started typing");
          }

          // Reset typing timer
          clearTimeout(this.typingTimer);
          this.typingTimer = setTimeout(() => {
            this.stopTyping();
          }, 1000);
        }

        stopTyping() {
          if (this.isTyping) {
            this.isTyping = false;
            this.socket.emit("typing_stop");
            clearTimeout(this.typingTimer);
            console.log("‚å®Ô∏è Stopped typing");
          }
        }

        handleTypingIndicator(data) {
          // Don't show typing indicator for own messages
          if (data.userId === this.currentUser?.userId) {
            return;
          }

          console.log("‚å®Ô∏è Handling typing indicator:", data);

          if (data.isTyping) {
            this.elements.typingIndicator.textContent = `${data.userName} is typing...`;

            // Clear typing indicator after 3 seconds if no update
            clearTimeout(this.typingTimeout);
            this.typingTimeout = setTimeout(() => {
              this.elements.typingIndicator.textContent = "";
            }, 3000);
          } else {
            this.elements.typingIndicator.textContent = "";
            clearTimeout(this.typingTimeout);
          }
        }

        showError(message) {
          this.elements.loginError.innerHTML = `<div class="error">${this.escapeHtml(
            message
          )}</div>`;

          // Reset join button
          this.elements.joinBtn.disabled = false;
          this.elements.joinBtn.textContent = "Join Chat Room";
        }

        clearError() {
          this.elements.loginError.innerHTML = "";
        }

        scrollToBottom() {
          this.elements.messagesContainer.scrollTop =
            this.elements.messagesContainer.scrollHeight;
        }

        escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }
      }

      // Initialize the chat application
      document.addEventListener("DOMContentLoaded", () => {
        console.log("üöÄ Initializing Hospital Chat...");
        new HospitalChat();
      });
    </script>
  </body>
</html>
